From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: DiaLight <light_01@rambler.ru>
Date: Thu, 11 Jul 2024 03:18:41 +0300
Subject: [PATCH] fix_close_window


diff --git a/dkii_exe_functions.cpp b/dkii_exe_functions.cpp
index 0000000..0000000 100644
--- a/dkii_exe_functions.cpp
+++ b/dkii_exe_functions.cpp
@@ -94,6 +94,23 @@ LRESULT dk2::CWindowTest_proc(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam)
         }
     }
     // end of patch bring_to_foreground
+    // patch fix_close_window
+    switch(Msg) {
+        case WM_CLOSE: {
+            dk2::CDefaultPlayerInterface *playetIf = &dk2::CDefaultPlayerInterface_instance;
+            if (playetIf->profiler != nullptr) {  // game is running
+                dk2::GameAction action;
+                ZeroMemory(&action, sizeof(action));
+                action.actionKind = dk2::GA_ExitToWindows;
+                action._cpyFrF8 = playetIf->_cpyToF10;
+                playetIf->pushAction(&action);
+            } else {
+                dk2::setAppExitStatus(true);
+            }
+            break;
+        }
+    }
+    // end of patch fix_close_window
     switch(Msg) {
         case WM_ACTIVATE:
             g_isNeedBlt_fullscr = wParam != 0;
